# Copyright (C) 2022 F4PGA Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#
# SPDX-License-Identifier: Apache-2.0

values:
  device: qlf_k4n8_umc22
  rr_graph_lookahead_bin: >-
    ${shareDir}/arch/qlf_k4n8-qlf_k4n8_umc22_slow_qlf_k4n8-qlf_k4n8_umc22_slow/rr_graph_qlf_k4n8-qlf_k4n8_umc22_slow_qlf_k4n8-qlf_k4n8_umc22_slow.lookahead.bin
  rr_graph_real_bin: >-
    ${shareDir}/arch/qlf_k4n8-qlf_k4n8_umc22_slow_qlf_k4n8-qlf_k4n8_umc22_slow/qlf_k4n8-qlf_k4n8_umc22_slow.rr_graph.bin
  vpr_place_delay: >-
    ${shareDir}/arch/qlf_k4n8-qlf_k4n8_umc22_slow_qlf_k4n8-qlf_k4n8_umc22_slow/rr_graph_qlf_k4n8-qlf_k4n8_umc22_slow_qlf_k4n8-qlf_k4n8_umc22_slow.place_delay.bin
  vpr_grid_layout_name: qlf_k4n8-qlf_k4n8_umc22_slow
  arch_def: >-
    ${shareDir}/arch/qlf_k4n8-qlf_k4n8_umc22_slow_qlf_k4n8-qlf_k4n8_umc22_slow/arch_qlf_k4n8-qlf_k4n8_umc22_slow_qlf_k4n8-qlf_k4n8_umc22_slow.xml
  vpr_options:
    max_router_iterations: 500
    routing_failure_predictor: 'off'
    router_high_fanout_threshold: -1
    constant_net_method: route
    route_chan_width: 100
    clock_modeling: ideal
    place_delta_delay_matrix_calculation_method: dijkstra
    place_delay_model: delta_override
    router_lookahead: extended_map
    allow_dangling_combinational_nodes: 'on'
    absorb_buffer_luts: 'off'
stages:
  mk_build_dir:
    module: 'common:mkdirs'
    params:
      build_dir: 'build/${device}'
  synth:
    common: synth
    params:
      produces:
        - synth_v
    values:
      tcl_scripts: '${shareDir}/scripts/qlf_k4n8'
      read_verilog_args: []
      yosys_tcl_env:
        TOP: '${top}'
        OUT_JSON: '${:json}'
        TECHMAP_PATH: '${shareDir}/techmaps/qlf_k4n8'
        OUT_SYNTH_V: '${:synth_v}'
        OUT_EBLIF: '${:eblif}'
        PYTHON3: '${python3}'
  pack:
    module: 'common:pack'
  ioplace:
    module: 'common:generic_script_wrapper'
    params:
      stage_name: ioplace
      interpreter: '${python3}'
      script: '${binDir}/python/ql_qlf_create_ioplace.py'
      outputs:
        io_place:
          mode: stdout
          target: '${:eblif[noext]}.ioplace'
      inputs:
        blif: '${:eblif}'
        net: '${:net}'
        pcf: '${:pcf}'
        pinmap_xml: >-
          ${shareDir}/arch/qlf_k4n8-qlf_k4n8_umc22_slow_qlf_k4n8-qlf_k4n8_umc22_slow/pinmap_qlf_k4n8_umc22.xml
        csv_file: >-
          ${shareDir}/arch/qlf_k4n8-qlf_k4n8_umc22_slow_qlf_k4n8-qlf_k4n8_umc22_slow/pinmap_qlf_k4n8_umc22.csv
        $PYTHONPATH: '${binDir}/python/'
  repack:
    module: 'common:generic_script_wrapper'
    params:
      stage_name: repack
      interpreter: '${python3}'
      script: '${binDir}/python/repacker/repack.py'
      outputs:
        eblif_repacked:
          mode: file
          file: '${:eblif[noext]}_repacked.eblif'
          target: '${:eblif[noext]}_repacked.eblif'
        place_repacked:
          mode: file
          file: '${:place[noext]}_repacked.place'
          target: '${:place[noext]}_repacked.place'
        net_repacked:
          mode: file
          file: '${:net[noext]}_repacked.net'
          target: '${:net[noext]}_repacked.net'
        repack_log:
          mode: stdout
          target: '${top}.repack.log'
      inputs:
        eblif-in: '${:eblif}'
        net-in: '${:net}'
        place-in: '${:place}'
        eblif-out: '${:eblif[noext]}_repacked.eblif'
        place-out: '${:place[noext]}_repacked.place'
        net-out: '${:net[noext]}_repacked.net'
        absorb_buffer_luts: 'on'
        vpr-arch: '${arch_def}'
        repacking-rules: '${repacking_rules}'
        json-constraints: '${json_constraints?}'
        pcf-constraints: '${pcf?}'
        $PYTHONPATH: '${binDir}/python/'
    values:
      repacking_rules: >-
        ${shareDir}/arch/qlf_k4n8-qlf_k4n8_umc22_slow_qlf_k4n8-qlf_k4n8_umc22_slow/qlf_k4n8-qlf_k4n8_umc22_slow.repacking_rules.json
  place:
    module: 'common:place'
  route:
    module: 'common:io_rename'
    params:
      module: 'common:route'
      rename_takes:
        eblif: eblif_repacked
        place: place_repacked
        net: net_repacked
  fasm:
    module: 'common:io_rename'
    params:
      module: 'common:fasm'
      rename_takes:
        eblif: eblif_repacked
        place: place_repacked
        net: net_repacked
  bitstream:
    module: 'common:generic_script_wrapper'
    params:
      stage_name: bitstream
      script: qlf_fasm
      outputs:
        bitstream:
          mode: file
          file: '${:fasm[noext]}.bit'
          target: '${:fasm[noext]}.bit'
      inputs:
        '#1': '${:fasm}'
        '#2': '${:fasm[noext]}.bit'
        db-root: '${shareDir}/fasm_database/qlf_k4n8'
        format: 4byte
        assemble: true
